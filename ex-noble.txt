async function fetchNovelContent(url) {
	console.log("[fetchNovelContent] ì‹œì‘", url);
	try {
		const response = await fetch(url);

		if (!response.ok) {
			console.error(
				`ì„œë²„ ì˜¤ë¥˜: ${url}ì—ì„œ ì½˜í…ì¸ ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒíƒœ: ${response.status}`,
			);
			console.log("[fetchNovelContent] ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨", response.status);
			return null;
		}

		const html = await response.text();
		const parser = new DOMParser();
		const doc = parser.parseFromString(html, "text/html");

		// ì—¬ëŸ¬ ì„ íƒìë¥¼ ì‹œë„í•©ë‹ˆë‹¤
		const titleSelectors = [
			".toon-title",
			".view-title",
			"h1.title",
			".post-title",
			".entry-title",
		];

		let titleElement = null;
		for (const selector of titleSelectors) {
			titleElement = doc.querySelector(selector);
			if (titleElement) {
				console.log(`[fetchNovelContent] ì œëª© ì„ íƒì ë°œê²¬: ${selector}`);
				break;
			}
		}

		let episodeTitle = "ì œëª© ì—†ëŠ” ì—í”¼ì†Œë“œ";
		if (titleElement) {
			episodeTitle =
				titleElement.getAttribute("title") ||
				titleElement.textContent.split("<br>")[0].trim() ||
				"ì œëª© ì—†ëŠ” ì—í”¼ì†Œë“œ";
			console.log("[fetchNovelContent] ì¶”ì¶œëœ ì œëª©:", episodeTitle);
		}

		// ì—¬ëŸ¬ ì½˜í…ì¸  ì„ íƒìë¥¼ ì‹œë„í•©ë‹ˆë‹¤
		const contentSelectors = [
			"#novel_content",
			".novel-content",
			".view-content",
			".entry-content",
			".post-content",
		];

		let content = null;
		for (const selector of contentSelectors) {
			content = doc.querySelector(selector);
			if (content) {
				console.log(`[fetchNovelContent] ì½˜í…ì¸  ì„ íƒì ë°œê²¬: ${selector}`);
				break;
			}
		}

		if (!content) {
			console.error(`ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${url}`);
			console.log("[fetchNovelContent] ì½˜í…ì¸  ìš”ì†Œ ì—†ìŒ");
			return null;
		}

		let cleanedContent = cleanText(content.innerHTML);
		if (cleanedContent.startsWith(episodeTitle)) {
			cleanedContent = cleanedContent.slice(episodeTitle.length).trim();
		}

		console.log(
			"[fetchNovelContent] ì •ì œëœ ì½˜í…ì¸ (100ì):",
			cleanedContent.slice(0, 100),
		);

		console.log("[fetchNovelContent] ì¢…ë£Œ", { episodeTitle });
		return {
			episodeTitle: episodeTitle,
			content: cleanedContent,
		};
	} catch (error) {
		console.error(`fetchNovelContent ì˜¤ë¥˜: ${error.message}`);
		console.log("[fetchNovelContent] ì˜ˆì™¸ ë°œìƒ", error);
		return null;
	}
}

function unescapeHTML(text) {
	const entities = {
		"&lt;": "<",
		"&gt;": ">",
		"&amp;": "&",
		"&quot;": '"',
		"&apos;": "'",
		"&nbsp;": " ",
		"&ndash;": "-",
		"&mdash;": "--",
		"&lsquo;": "'",
		"&rsquo;": "'",
		"&ldquo;": '"',
		"&rdquo;": '"',
	};

	let result = text;
	for (const [entity, replacement] of Object.entries(entities)) {
		const regex = new RegExp(entity, "g");
		result = result.replace(regex, replacement);
	}

	return result;
}

function cleanText(text) {
	let cleaned = text;
	cleaned = cleaned.replace(/<div>/g, "");
	cleaned = cleaned.replace(/<\/div>/g, "");
	cleaned = cleaned.replace(/<p>/g, "\n");
	cleaned = cleaned.replace(/<\/p>/g, "\n");
	cleaned = cleaned.replace(/<br\s*[/]?>/g, "\n");
	cleaned = cleaned.replace(/<img[^>]*>/gi, "[ì´ë¯¸ì§€ ê±´ë„ˆëœ€]");
	cleaned = cleaned.replace(/<[^>]*>/g, "");
	cleaned = cleaned.replace(/ {2,}/g, " ");
	cleaned = unescapeHTML(cleaned);

	cleaned = cleaned
		.split("\n")
		.map((line) => line.trim())
		.filter((line) => line.length > 0)
		.join("\n\n")
		.replace(/\n{3,}/g, "\n\n");

	return cleaned;
}

function createModal(title, isBusyRef) {
	// ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ì´ ì•„ì§ ì¶”ê°€ë˜ì§€ ì•Šì€ ê²½ìš° ë¬¸ì„œì— ì¶”ê°€í•©ë‹ˆë‹¤
	if (!document.getElementById("novel-dl-styles")) {
		const style = document.createElement("style");
		style.id = "novel-dl-styles";
		style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes pulse {
                0% { opacity: 0.7; }
                50% { opacity: 1; }
                100% { opacity: 0.7; }
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
		document.head.appendChild(style);
	}

	// ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ ìƒì„±
	const modal = document.createElement("div");
	modal.id = "downloadProgressModal";
	Object.assign(modal.style, {
		display: "flex",
		position: "fixed",
		zIndex: "9999",
		left: "0",
		top: "0",
		width: "100%",
		height: "100%",
		backgroundColor: "rgba(0,0,0,0.5)",
		alignItems: "center",
		justifyContent: "center",
		fontFamily:
			'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
	});

	// ëª¨ë‹¬ ì½˜í…ì¸  ìƒì„±
	const modalContent = document.createElement("div");
	Object.assign(modalContent.style, {
		backgroundColor: "#fff",
		borderRadius: "12px",
		boxShadow: "0 4px 24px rgba(0,0,0,0.15)",
		width: "450px",
		maxWidth: "90%",
		padding: "0",
		overflow: "hidden",
		animation: "fadeIn 0.3s",
	});

	// í—¤ë” ìƒì„±
	const header = document.createElement("div");
	Object.assign(header.style, {
		backgroundColor: "#f9f9fb",
		borderBottom: "1px solid #eaecef",
		padding: "16px 20px",
		display: "flex",
		justifyContent: "space-between",
		alignItems: "center",
	});

	// í—¤ë”ì— ì œëª© ì¶”ê°€
	const headerTitle = document.createElement("h3");
	headerTitle.textContent = title;
	Object.assign(headerTitle.style, {
		margin: "0",
		color: "#172238",
		fontSize: "16px",
		fontWeight: "600",
	});
	header.appendChild(headerTitle);

	// ë‹«ê¸° ë²„íŠ¼ ì¶”ê°€
	const closeButton = document.createElement("button");
	closeButton.innerHTML = "&times;";
	Object.assign(closeButton.style, {
		background: "none",
		border: "none",
		fontSize: "22px",
		cursor: "pointer",
		color: "#666",
		padding: "0 4px",
		lineHeight: "1",
	});
	closeButton.onclick = () => {
		if (isBusyRef?.value) {
			if (confirm("ë‹¤ìš´ë¡œë“œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
				document.body.removeChild(modal);
			}
		} else {
			document.body.removeChild(modal);
		}
	};
	header.appendChild(closeButton);

	modalContent.appendChild(header);

	// ë³¸ë¬¸ ìƒì„±
	const body = document.createElement("div");
	Object.assign(body.style, {
		padding: "20px",
	});
	modalContent.appendChild(body);

	// ìƒíƒœ ìš”ì†Œ ìƒì„±
	const statusElement = document.createElement("div");
	Object.assign(statusElement.style, {
		marginBottom: "16px",
		fontSize: "14px",
		color: "#444",
		fontWeight: "500",
	});
	body.appendChild(statusElement);

	// ì§„í–‰ ì •ë³´ ìš”ì†Œ ìƒì„±
	const progressInfo = document.createElement("div");
	Object.assign(progressInfo.style, {
		display: "flex",
		justifyContent: "space-between",
		marginBottom: "10px",
		fontSize: "14px",
		color: "#555",
	});

	const progressText = document.createElement("div");
	progressText.textContent = "0%";
	Object.assign(progressText.style, {
		fontWeight: "600",
	});
	progressInfo.appendChild(progressText);

	const timeRemaining = document.createElement("div");
	progressInfo.appendChild(timeRemaining);

	body.appendChild(progressInfo);

	// ì§„í–‰ë¥  í‘œì‹œì¤„ ì»¨í…Œì´ë„ˆ ìƒì„±
	const progressBarContainer = document.createElement("div");
	Object.assign(progressBarContainer.style, {
		width: "100%",
		height: "8px",
		backgroundColor: "#eaecef",
		borderRadius: "8px",
		overflow: "hidden",
	});

	// ì§„í–‰ë¥  í‘œì‹œì¤„ ìƒì„±
	const progressBar = document.createElement("div");
	Object.assign(progressBar.style, {
		width: "0%",
		height: "100%",
		background: "linear-gradient(90deg, #3a7bd5, #6fa1ff)",
		borderRadius: "8px",
		transition: "width 0.3s ease",
	});

	progressBarContainer.appendChild(progressBar);
	body.appendChild(progressBarContainer);

	// ìƒì„¸ ì§„í–‰ë¥  ìš”ì†Œ ìƒì„±
	const detailedProgress = document.createElement("div");
	Object.assign(detailedProgress.style, {
		marginTop: "16px",
		fontSize: "13px",
		color: "#666",
		textAlign: "center",
	});
	body.appendChild(detailedProgress);

	modal.appendChild(modalContent);

	return {
		modal,
		statusElement,
		progressText,
		timeRemaining,
		progressBar,
		detailedProgress,
		closeButton,
	};
}

// ì´ë™ í‰ê· ì„ ì‚¬ìš©í•œ ê°œì„ ëœ ì‹œê°„ ì¶”ì • í•¨ìˆ˜
function createProgressTracker(totalItems) {
	const startTime = Date.now();
	const processingTimes = [];
	const MAX_SAMPLES = 5; // ì´ë™ í‰ê· ì— ë§ˆì§€ë§‰ 5ê°œ ìƒ˜í”Œ ì‚¬ìš©

	return {
		update: (completedItems) => {
			const progress = (completedItems / totalItems) * 100;

			const elapsed = Date.now() - startTime;

			// í•­ëª©ë‹¹ ì‹œê°„ ê³„ì‚° ë° ì´ë™ í‰ê· ì„ ìœ„í•´ ì €ì¥
			if (completedItems > 0) {
				const currentTimePerItem = elapsed / completedItems;
				processingTimes.push(currentTimePerItem);

				// ê°€ì¥ ìµœê·¼ ìƒ˜í”Œë§Œ ìœ ì§€
				if (processingTimes.length > MAX_SAMPLES) {
					processingTimes.shift();
				}
			}

			// ì²˜ë¦¬ ì‹œê°„ì˜ ì´ë™ í‰ê·  ê³„ì‚°
			const avgTimePerItem =
				processingTimes.length > 0
					? processingTimes.reduce((sum, time) => sum + time, 0) /
						processingTimes.length
					: 0;

			// ì´ë™ í‰ê· ì„ ê¸°ë°˜ìœ¼ë¡œ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
			const remainingItems = totalItems - completedItems;
			const estimatedRemainingTime = avgTimePerItem * remainingItems;

			return {
				progress: progress.toFixed(1),
				remaining: formatTime(estimatedRemainingTime),
				elapsed: formatTime(elapsed),
				speed: avgTimePerItem > 0 ? (1000 / avgTimePerItem).toFixed(2) : "0.00", // ì´ˆë‹¹ í•­ëª© ìˆ˜
			};
		},
	};
}

function formatTime(ms) {
	if (ms < 60000) {
		return `${Math.ceil(ms / 1000)}ì´ˆ`;
	}
	if (ms < 3600000) {
		const mins = Math.floor(ms / 60000);
		const secs = Math.floor((ms % 60000) / 1000);
		return `${mins}ë¶„ ${secs}ì´ˆ`;
	}
	const hours = Math.floor(ms / 3600000);
	const mins = Math.floor((ms % 3600000) / 60000);
	return `${hours}ì‹œê°„ ${mins}ë¶„`;
}

async function loadScript(url) {
	return new Promise((resolve, reject) => {
		const script = document.createElement("script");
		script.src = url;
		script.onload = resolve;
		script.onerror = reject;
		document.head.appendChild(script);
	});
}

function sanitizeFilename(name) {
	return name.replace(/[/\\?%*:|"<>]/g, "_");
}

async function downloadNovel(
	title,
	episodeLinks,
	startEpisode,
	endEpisode,
	delayMs = 5000,
	pauseInterval = 53,
) {
	console.log("[downloadNovel] ì‹œì‘", {
		title,
		startEpisode,
		endEpisode,
		delayMs,
		pauseInterval,
	});
	
		// script.txtì™€ ë™ì¼í•œ êµ¬ì¡°
	// ì €ì¥ ì˜µì…˜ ì„ íƒì„ ìœ„í•œ ìµœì‹  ëŒ€í™” ìƒì ìƒì„±
	const dialog = document.createElement("div");
	Object.assign(dialog.style, {
		position: "fixed",
		zIndex: "9999",
		left: "0",
		top: "0",
		width: "100%",
		height: "100%",
		backgroundColor: "rgba(0,0,0,0.5)",
		display: "flex",
		alignItems: "center",
		justifyContent: "center",
		fontFamily:
			'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
	});

	const dialogContent = document.createElement("div");
	Object.assign(dialogContent.style, {
		backgroundColor: "#fff",
		borderRadius: "12px",
		boxShadow: "0 4px 24px rgba(0,0,0,0.15)",
		width: "350px",
		maxWidth: "90%",
		padding: "24px",
		animation: "fadeIn 0.3s",
	});

	const dialogTitle = document.createElement("h3");
	dialogTitle.textContent = "ì €ì¥ ë°©ì‹ ì„ íƒ";
	Object.assign(dialogTitle.style, {
		margin: "0 0 20px 0",
		color: "#172238",
		fontSize: "18px",
		fontWeight: "600",
	});
	dialogContent.appendChild(dialogTitle);

	const optionsContainer = document.createElement("div");
	Object.assign(optionsContainer.style, {
		display: "flex",
		flexDirection: "column",
		gap: "12px",
		marginBottom: "24px",
	});

	const createOption = (value, text, description) => {
		const option = document.createElement("div");
		Object.assign(option.style, {
			padding: "14px",
			border: "1px solid #e4e9f0",
			borderRadius: "8px",
			cursor: "pointer",
			backgroundColor: "#f9f9fb",
			transition: "all 0.2s ease",
		});

		option.innerHTML = `
            <div style="font-weight: 600; color: #172238; margin-bottom: 4px;">${text}</div>
            <div style="font-size: 13px; color: #666;">${description}</div>
        `;

		option.onclick = () => {
			document.body.removeChild(dialog);
			processDownload(value !== "1");
		};

		option.onmouseover = () => {
			option.style.backgroundColor = "#f0f2f8";
			option.style.borderColor = "#3a7bd5";
		};

		option.onmouseout = () => {
			option.style.backgroundColor = "#f9f9fb";
			option.style.borderColor = "#e4e9f0";
		};

		return option;
	};

	optionsContainer.appendChild(
		createOption(
			"1",
			"í•œ íŒŒì¼ë¡œ ë³‘í•©",
			"ëª¨ë“  íšŒì°¨ê°€ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.",
		),
	);
	optionsContainer.appendChild(
		createOption(
			"2",
			"ê° íšŒì°¨ë³„ ì €ì¥ (ZIP)",
			"ê° íšŒì°¨ë¥¼ ê°œë³„ íŒŒì¼ë¡œ ZIP ì••ì¶•í•©ë‹ˆë‹¤.",
		),
	);

	dialogContent.appendChild(optionsContainer);

	const cancelButton = document.createElement("button");
	cancelButton.textContent = "ì·¨ì†Œ";
	Object.assign(cancelButton.style, {
		width: "100%",
		padding: "10px",
		border: "1px solid #e4e9f0",
		borderRadius: "8px",
		backgroundColor: "#f9f9fb",
		cursor: "pointer",
		fontSize: "14px",
		fontWeight: "500",
		transition: "all 0.2s ease",
	});

	cancelButton.onmouseover = () => {
		cancelButton.style.backgroundColor = "#f0f2f8";
	};

	cancelButton.onmouseout = () => {
		cancelButton.style.backgroundColor = "#f9f9fb";
	};

	cancelButton.onclick = () => {
		document.body.removeChild(dialog);
	};

	dialogContent.appendChild(cancelButton);

	// í•˜ë‹¨ì— ê°œë°œì ì—°ë½ì²˜ ë§í¬ ì¶”ê°€
	const contactContainer = document.createElement("div");
	Object.assign(contactContainer.style, {
		marginTop: "16px",
		textAlign: "center",
		fontSize: "13px",
	});

	const contactLink = document.createElement("a");
	contactLink.href = "mailto:yeorinhieut@gmail.com";
	contactLink.textContent = "ê°œë°œìì—ê²Œ ì—°ë½í•˜ê¸°";
	Object.assign(contactLink.style, {
		color: "#666",
		textDecoration: "none",
		borderBottom: "1px dotted #999",
	});

	contactLink.onmouseover = () => {
		contactLink.style.color = "#3a7bd5";
		contactLink.style.borderBottom = "1px dotted #3a7bd5";
	};

	contactLink.onmouseout = () => {
		contactLink.style.color = "#666";
		contactLink.style.borderBottom = "1px dotted #999";
	};

	contactContainer.appendChild(contactLink);

	// êµ¬ë¶„ ê¸°í˜¸ ì¶”ê°€
	const separator = document.createElement("span");
	separator.textContent = " Â· ";
	separator.style.color = "#999";
	contactContainer.appendChild(separator);

	// ë¬¸ì œ ë³´ê³  ë§í¬ ì¶”ê°€
	const issueLink = document.createElement("a");
	issueLink.href = "https://github.com/yeorinhieut/novel-dl/issues";
	issueLink.textContent = "ì˜¤ë¥˜ ì œë³´í•˜ê¸°";
	issueLink.target = "_blank"; // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
	Object.assign(issueLink.style, {
		color: "#666",
		textDecoration: "none",
		borderBottom: "1px dotted #999",
	});

	issueLink.onmouseover = () => {
		issueLink.style.color = "#3a7bd5";
		issueLink.style.borderBottom = "1px dotted #3a7bd5";
	};

	issueLink.onmouseout = () => {
		issueLink.style.color = "#666";
		issueLink.style.borderBottom = "1px dotted #999";
	};

	contactContainer.appendChild(issueLink);
	dialogContent.appendChild(contactContainer);

	dialog.appendChild(dialogContent);
	document.body.appendChild(dialog);

	async function processDownload(saveAsZip) {
		console.log("[downloadNovel] ì €ì¥ ë°©ì‹:", saveAsZip ? "ZIP" : "ë‹¨ì¼ íŒŒì¼");
		let zip;

		if (saveAsZip) {
			try {
				await loadScript(
					"https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
				);
				zip = new JSZip();
				console.log("[downloadNovel] JSZip ë¡œë“œ ì„±ê³µ");
			} catch (e) {
				console.log("[downloadNovel] JSZip ë¡œë“œ ì‹¤íŒ¨", e);
				alert("ZIP ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨!");
				return;
			}
		}

		const startingIndex = episodeLinks.length - startEpisode;
		const endingIndex = episodeLinks.length - endEpisode;
		const totalEpisodes = startingIndex - endingIndex + 1;
		console.log("[downloadNovel] ë‹¤ìš´ë¡œë“œ ë²”ìœ„", {
			startingIndex,
			endingIndex,
			totalEpisodes,
		});

		const {
			modal,
			statusElement,
			progressText,
			timeRemaining,
			progressBar,
			detailedProgress,
		} = createModal(`"${title}" ë‹¤ìš´ë¡œë“œ ì¤‘`, { value: true });
		
		// ê°„ë‹¨í•œ ì¼ì‹œì •ì§€ ë²„íŠ¼ ì¶”ê°€
		const pauseResumeButton = document.createElement("button");
		pauseResumeButton.textContent = "ì¼ì‹œì •ì§€";
		Object.assign(pauseResumeButton.style, {
			position: "absolute",
			top: "16px",
			right: "60px",
			backgroundColor: "#ff9800",
			color: "white",
			border: "none",
			padding: "8px 16px",
			borderRadius: "6px",
			fontSize: "12px",
			fontWeight: "500",
			cursor: "pointer",
			transition: "background-color 0.2s",
		});

		// ì¼ì‹œì •ì§€ ìƒíƒœ ê´€ë¦¬
		let isPaused = false;

		pauseResumeButton.onclick = () => {
			isPaused = !isPaused;
			if (isPaused) {
				pauseResumeButton.textContent = "ì¬ê°œ";
				pauseResumeButton.style.backgroundColor = "#4caf50";
				statusElement.textContent = "ë‹¤ìš´ë¡œë“œ ì¼ì‹œì •ì§€ë¨ (ì¬ê°œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”)";
			} else {
				pauseResumeButton.textContent = "ì¼ì‹œì •ì§€";
				pauseResumeButton.style.backgroundColor = "#ff9800";
				statusElement.textContent = "ë‹¤ìš´ë¡œë“œ ì¬ê°œë¨...";
			}
		};

		// ëª¨ë‹¬ í—¤ë”ì— ë²„íŠ¼ ì¶”ê°€
		const modalHeader = modal.querySelector("div[style*='background-color: rgb(249, 249, 251)']") || 
		                   modal.querySelector("div[style*='backgroundColor: #f9f9fb']") ||
		                   modal.querySelector("div[style*='background-color: #f9f9fb']");
		
		if (modalHeader) {
			modalHeader.style.position = "relative";
			modalHeader.appendChild(pauseResumeButton);
		}

		document.body.appendChild(modal);

		// ì§„í–‰ ì¶”ì ê¸° ì´ˆê¸°í™”
		const progressTracker = createProgressTracker(totalEpisodes);
		let novelText = `${title}\n\n`;
		let completedEpisodes = 0;
		let failedEpisodes = 0;
		let captchaCount = 0;

		statusElement.textContent = "ë‹¤ìš´ë¡œë“œë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘...";

		for (let i = startingIndex; i >= endingIndex; i--) {
			// ì‚¬ìš©ì ì •ì˜ ê°„ê²©ë§ˆë‹¤ ìë™ ì¼ì‹œì •ì§€
			if (pauseInterval > 0 && completedEpisodes > 0 && completedEpisodes % pauseInterval === 0) {
				isPaused = true;
				pauseResumeButton.textContent = "ì¬ê°œ";
				pauseResumeButton.style.backgroundColor = "#4caf50";
				statusElement.textContent = `âš ï¸ ${pauseInterval}í™” ì™„ë£Œ! ìë™ ì¼ì‹œì •ì§€ë¨ (ì¬ê°œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”)`;
			}
			
			// ì¼ì‹œì •ì§€ ìƒíƒœ í™•ì¸
			while (isPaused) {
				await new Promise((resolve) => setTimeout(resolve, 100));
			}
			
			const episodeUrl = episodeLinks[i];
			console.log(`[downloadNovel] ${i}ë²ˆì§¸ ì—í”¼ì†Œë“œ URL:`, episodeUrl);
			if (!episodeUrl.startsWith("https://booktoki")) {
				failedEpisodes++;
				console.log(`[downloadNovel] booktoki URL ì•„ë‹˜, ê±´ë„ˆëœ€: ${episodeUrl}`);
				continue;
			}

			const currentEpisode = startingIndex - i + 1;
			const episodeNumber = episodeLinks.length - i;
			statusElement.textContent = `${episodeNumber}í™” ë‹¤ìš´ë¡œë“œ ì¤‘... (${currentEpisode}/${totalEpisodes})`;

			let result = null;
			try {
				result = await fetchNovelContent(episodeUrl);
			} catch (fetchError) {
				console.error(`[downloadNovel] fetchNovelContent ì˜¤ë¥˜: ${fetchError.message}`);
				result = null;
			}
			
			if (!result) {
				captchaCount++;
				statusElement.textContent = `âš ï¸ CAPTCHA ê°ì§€ë¨! ${episodeNumber}í™”ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
				console.log(
					`[downloadNovel] CAPTCHA ê°ì§€, ì‚¬ìš©ì í™•ì¸ ëŒ€ê¸°: ${episodeUrl}`,
				);

				const userConfirmed = confirm(
					`CAPTCHAê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n${episodeUrl}\n\nìº¡ì± ë¥¼ í•´ê²°í•œ í›„ í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`,
				);
				if (!userConfirmed) {
					failedEpisodes++;
					console.log(
						`[downloadNovel] ì‚¬ìš©ì ìº¡ì±  ë¯¸í•´ê²°, ê±´ë„ˆëœ€: ${episodeUrl}`,
					);
					continue;
				}

				statusElement.textContent = `${episodeNumber}í™” ë‹¤ì‹œ ì‹œë„ ì¤‘...`;
				result = await fetchNovelContent(episodeUrl);
				if (!result) {
					statusElement.textContent = `âŒ ${episodeNumber}í™” ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨`;
					failedEpisodes++;
					console.log(`[downloadNovel] ì¬ì‹œë„ ì‹¤íŒ¨: ${episodeUrl}`);
					continue;
				}
			}

			const { episodeTitle, content } = result;
			console.log(`[downloadNovel] ì—í”¼ì†Œë“œ ë‹¤ìš´ë¡œë“œ ì„±ê³µ: ${episodeTitle}`);

			if (saveAsZip) {
				zip.file(`${sanitizeFilename(episodeTitle)}.txt`, content);
			} else {
				novelText += `${episodeTitle}\n\n${content}\n\n`;
			}

			completedEpisodes++;
			const stats = progressTracker.update(completedEpisodes);

			if (progressBar && progressBar.style) {
				progressBar.style.width = `${stats.progress}%`;
			}
			if (progressText) {
				progressText.textContent = `${stats.progress}%`;
			}
			if (timeRemaining) {
				timeRemaining.textContent = `ë‚¨ì€ ì‹œê°„: ${stats.remaining}`;
			}

			detailedProgress.innerHTML = `
                <div style="margin-bottom: 4px; display: flex; justify-content: center; gap: 12px;">
                    <span>âœ… ì™„ë£Œ: ${completedEpisodes}í™”</span>
                    <span>âŒ ì‹¤íŒ¨: ${failedEpisodes}í™”</span>
                    <span>âš ï¸ ìº¡ì± : ${captchaCount}íšŒ</span>
                </div>
                <div>ì†Œìš” ì‹œê°„: ${stats.elapsed} | ì²˜ë¦¬ ì†ë„: ${stats.speed}í™”/ì´ˆ</div>
            `;

			// ì†ë„ ì œí•œì„ ë°©ì§€í•˜ê¸° ìœ„í•´ êµ¬ì„± ê°€ëŠ¥í•œ ì§€ì—° ì¶”ê°€
			await new Promise((r) => setTimeout(r, delayMs));
		}

		console.log("[downloadNovel] ë‹¤ìš´ë¡œë“œ ë£¨í”„ ì¢…ë£Œ", {
			completedEpisodes,
			failedEpisodes,
			captchaCount,
		});
		if (statusElement) {
			statusElement.textContent = "âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ, íŒŒì¼ ìƒì„± ì¤‘...";
		}
		if (progressBar && progressBar.style) {
			progressBar.style.width = "100%";
		}
		if (progressText) {
			progressText.textContent = "100%";
		}

		setTimeout(() => {
			console.log("[downloadNovel] íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ");
			document.body.removeChild(modal);

			// ì™„ë£Œ ëŒ€í™” ìƒì ìƒì„±
			const completionDialog = document.createElement("div");
			Object.assign(completionDialog.style, {
				position: "fixed",
				zIndex: "9999",
				left: "0",
				top: "0",
				width: "100%",
				height: "100%",
				backgroundColor: "rgba(0,0,0,0.5)",
				display: "flex",
				alignItems: "center",
				justifyContent: "center",
				fontFamily:
					'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
			});

			const completionContent = document.createElement("div");
			Object.assign(completionContent.style, {
				backgroundColor: "#fff",
				borderRadius: "12px",
				boxShadow: "0 4px 24px rgba(0,0,0,0.15)",
				width: "400px",
				maxWidth: "90%",
				padding: "24px",
				animation: "fadeIn 0.3s",
				textAlign: "center",
			});

			// ì„±ê³µ ì•„ì´ì½˜
			const successIcon = document.createElement("div");
			successIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            `;
			Object.assign(successIcon.style, {
				display: "flex",
				justifyContent: "center",
				marginBottom: "16px",
			});
			completionContent.appendChild(successIcon);

			// ì™„ë£Œ ì œëª©
			const completionTitle = document.createElement("h3");
			completionTitle.textContent = "ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆì–´ìš”!";
			Object.assign(completionTitle.style, {
				color: "#172238",
				fontSize: "18px",
				margin: "0 0 8px 0",
			});
			completionContent.appendChild(completionTitle);

			// ì™„ë£Œ ë©”ì‹œì§€
			const completionMessage = document.createElement("p");
			completionMessage.textContent = `${completedEpisodes}í™”ì˜ ë‹¤ìš´ë¡œë“œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.`;
			Object.assign(completionMessage.style, {
				color: "#666",
				margin: "0 0 24px 0",
				fontSize: "14px",
			});
			completionContent.appendChild(completionMessage);

			// ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
			const downloadBtn = document.createElement("button");
			downloadBtn.textContent = "ë‹¤ìš´ë¡œë“œ";
			Object.assign(downloadBtn.style, {
				backgroundColor: "#4CAF50",
				color: "white",
				border: "none",
				padding: "12px 24px",
				borderRadius: "8px",
				fontSize: "14px",
				fontWeight: "500",
				cursor: "pointer",
				marginBottom: "24px",
				width: "100%",
				transition: "background-color 0.2s",
			});

			downloadBtn.onmouseover = () => {
				downloadBtn.style.backgroundColor = "#388E3C";
			};

			downloadBtn.onmouseout = () => {
				downloadBtn.style.backgroundColor = "#4CAF50";
			};

			downloadBtn.onclick = () => {
				if (saveAsZip) {
					zip.generateAsync({ type: "blob" }).then((blob) => {
						const a = document.createElement("a");
						a.href = URL.createObjectURL(blob);
						a.download = `${sanitizeFilename(title)}.zip`;
						a.click();

						// ë‹¤ìš´ë¡œë“œ í´ë¦­ í›„ ì„±ê³µ ì•Œë¦¼ í‘œì‹œ
						showNotification(
							`"${title}" ë‹¤ìš´ë¡œë“œ ì‹œì‘`,
							`${completedEpisodes}í™”ê°€ ZIP íŒŒì¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`,
						);
						showChromeNotification(
							`"${title}" ë‹¤ìš´ë¡œë“œ ì‹œì‘`,
							`${completedEpisodes}í™”ê°€ ZIP íŒŒì¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`,
						);
						document.body.removeChild(completionDialog);
					});
				} else {
					const blob = new Blob([novelText], { type: "text/plain" });
					const a = document.createElement("a");
					a.href = URL.createObjectURL(blob);
					a.download = `${sanitizeFilename(title)}(${startEpisode}~${endEpisode}).txt`;
					a.click();

					// ë‹¤ìš´ë¡œë“œ í´ë¦­ í›„ ì„±ê³µ ì•Œë¦¼ í‘œì‹œ
					showNotification(
						`"${title}" ë‹¤ìš´ë¡œë“œ ì‹œì‘`,
						`${completedEpisodes}í™”ê°€ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`,
					);
					showChromeNotification(
						`"${title}" ë‹¤ìš´ë¡œë“œ ì‹œì‘`,
						`${completedEpisodes}í™”ê°€ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`,
					);
					document.body.removeChild(completionDialog);
				}
			};

			completionContent.appendChild(downloadBtn);

			// ê°œë°œì ì—°ë½ì²˜ ë§í¬
			const contactLink = document.createElement("a");
			contactLink.href = "mailto:yeorinhieut@gmail.com";
			contactLink.textContent = "ê°œë°œìì—ê²Œ ì—°ë½í•˜ê¸°";
			Object.assign(contactLink.style, {
				display: "inline-block",
				color: "#666",
				fontSize: "13px",
				textDecoration: "none",
				borderBottom: "1px dotted #999",
			});

			contactLink.onmouseover = () => {
				contactLink.style.color = "#3a7bd5";
				contactLink.style.borderBottom = "1px dotted #3a7bd5";
			};

			contactLink.onmouseout = () => {
				contactLink.style.color = "#666";
				contactLink.style.borderBottom = "1px dotted #999";
			};

			completionContent.appendChild(contactLink);

			// êµ¬ë¶„ ê¸°í˜¸ ì¶”ê°€
			const separator = document.createElement("span");
			separator.textContent = " Â· ";
			separator.style.color = "#999";
			contactContainer.appendChild(separator);

			// ë¬¸ì œ ë³´ê³  ë§í¬ ì¶”ê°€
			const issueLink = document.createElement("a");
			issueLink.href = "https://github.com/yeorinhieut/novel-dl/issues";
			issueLink.textContent = "ì˜¤ë¥˜ ì œë³´í•˜ê¸°";
			issueLink.target = "_blank"; // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
			Object.assign(issueLink.style, {
				color: "#666",
				fontSize: "13px",
				textDecoration: "none",
				borderBottom: "1px dotted #999",
			});

			issueLink.onmouseover = () => {
				issueLink.style.color = "#3a7bd5";
				issueLink.style.borderBottom = "1px dotted #3a7bd5";
			};

			issueLink.onmouseout = () => {
				issueLink.style.color = "#666";
				issueLink.style.borderBottom = "1px dotted #999";
			};

			contactContainer.appendChild(issueLink);
			const rangeContent = document.createElement("div");
			rangeContent.appendChild(contactContainer);
			document.body.appendChild(rangeContent);

			completionDialog.appendChild(completionContent);
			document.body.appendChild(completionDialog);
		}, 500);
		// script.txtì™€ ë™ì¼í•œ êµ¬ì¡°ë¡œ ë‹¨ìˆœí™” ì™„ë£Œ
	}
}

function showNotification(title, message) {
	const notification = document.createElement("div");
	Object.assign(notification.style, {
		position: "fixed",
		bottom: "20px",
		right: "20px",
		backgroundColor: "#fff",
		borderLeft: "4px solid #4CAF50",
		borderRadius: "4px",
		boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
		padding: "16px",
		zIndex: "9999",
		maxWidth: "320px",
		fontFamily:
			'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
		animation: "fadeIn 0.3s",
	});

	notification.innerHTML = `
        <div style="font-weight: 600; color: #172238; margin-bottom: 4px;">${title}</div>
        <div style="font-size: 13px; color: #666;">${message}</div>
    `;

	document.body.appendChild(notification);

	// 5ì´ˆ í›„ ìë™ ì œê±°
	setTimeout(() => {
		notification.style.opacity = "0";
		notification.style.transition = "opacity 0.3s";
		setTimeout(() => document.body.removeChild(notification), 300);
	}, 5000);
}

function showChromeNotification(title, message) {
	if (!("Notification" in window)) {
		console.log("[showChromeNotification] ì´ ë¸Œë¼ìš°ì €ëŠ” ë°ìŠ¤í¬í†± ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
		return;
	}
	
	if (Notification.permission === "granted") {
		const notification = new Notification(title, {
			body: message,
			icon: "https://raw.githubusercontent.com/yeorinhieut/novel-dl/main/icon.png"
		});
		
		// 5ì´ˆ í›„ ìë™ ì¢…ë£Œ
		setTimeout(() => notification.close(), 5000);
	} 
	else if (Notification.permission !== "denied") {
		Notification.requestPermission().then(permission => {
			if (permission === "granted") {
				const notification = new Notification(title, {
					body: message,
					icon: "https://raw.githubusercontent.com/yeorinhieut/novel-dl/main/icon.png"
				});
				
				// 5ì´ˆ í›„ ìë™ ì¢…ë£Œ
				setTimeout(() => notification.close(), 5000);
			}
		});
	}
}

function extractTitle() {
	const titleElement = document.evaluate(
		'//*[@id="content_wrapper"]/div[1]/span',
		document,
		null,
		XPathResult.FIRST_ORDERED_NODE_TYPE,
		null,
	).singleNodeValue;
	return titleElement ? titleElement.textContent.trim() : null;
}

function extractEpisodeLinks() {
	const episodeLinks = [];
	const links = document.querySelectorAll(".item-subject");

	for (const link of links) {
		const episodeLink = link.getAttribute("href");
		episodeLinks.push(episodeLink);
	}

	return episodeLinks;
}

async function fetchPage(url) {
	const response = await fetch(url);
	if (!response.ok) {
		console.error(`Failed to fetch page: ${url}. Status: ${response.status}`);
		return null;
	}
	const html = await response.text();
	const parser = new DOMParser();
	const doc = parser.parseFromString(html, "text/html");
	return doc;
}

async function runCrawler() {
	console.log("[runCrawler] ì‹œì‘");
	const novelPageRule = "https://booktoki";
	let currentUrl = window.location.href;

	// URL ì •ë¦¬
	const urlParts = currentUrl.split("?")[0];
	currentUrl = urlParts;

	console.log("[runCrawler] í˜„ì¬ URL:", currentUrl);

	if (!currentUrl.startsWith(novelPageRule)) {
		alert("ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¶í† ê¸° ì†Œì„¤ ëª©ë¡ í˜ì´ì§€ì—ì„œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.");
		console.log("[runCrawler] ë¶í† ê¸° í˜ì´ì§€ ì•„ë‹˜, ì¢…ë£Œ");
		return;
	}

	const title = extractTitle();
	console.log("[runCrawler] ì¶”ì¶œëœ ì œëª©:", title);

	if (!title) {
		alert("ì†Œì„¤ ì œëª©ì„ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
		console.log("[runCrawler] ì œëª© ì¶”ì¶œ ì‹¤íŒ¨, ì¢…ë£Œ");
		return;
	}

	// ì…ë ¥ì„ ìœ„í•œ ìµœì‹  UI ìƒì„±
	const dialog = document.createElement("div");
	Object.assign(dialog.style, {
		position: "fixed",
		zIndex: "9999",
		left: "0",
		top: "0",
		width: "100%",
		height: "100%",
		backgroundColor: "rgba(0,0,0,0.5)",
		display: "flex",
		alignItems: "center",
		justifyContent: "center",
		fontFamily:
			'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
	});

	const dialogContent = document.createElement("div");
	Object.assign(dialogContent.style, {
		backgroundColor: "#fff",
		borderRadius: "12px",
		boxShadow: "0 4px 24px rgba(0,0,0,0.15)",
		width: "400px",
		maxWidth: "90%",
		padding: "24px",
		animation: "fadeIn 0.3s",
	});

	const dialogTitle = document.createElement("h3");
	dialogTitle.textContent = `"${title}" ë‹¤ìš´ë¡œë“œ ì„¤ì •`;
	Object.assign(dialogTitle.style, {
		margin: "0 0 20px 0",
		color: "#172238",
		fontSize: "18px",
		fontWeight: "600",
	});
	dialogContent.appendChild(dialogTitle);

	// ì…ë ¥ ê·¸ë£¹ ìƒì„± í•¨ìˆ˜
	function createInputGroup(
		labelText,
		inputType,
		defaultValue,
		placeholder,
		description,
		validator,
	) {
		const group = document.createElement("div");
		Object.assign(group.style, {
			marginBottom: "20px",
		});

		const label = document.createElement("label");
		label.textContent = labelText;
		Object.assign(label.style, {
			display: "block",
			marginBottom: "8px",
			fontSize: "14px",
			color: "#444",
			fontWeight: "500",
		});
		group.appendChild(label);

		if (description) {
			const desc = document.createElement("div");
			desc.textContent = description;
			Object.assign(desc.style, {
				fontSize: "13px",
				color: "#666",
				marginBottom: "8px",
			});
			group.appendChild(desc);
		}

		const input = document.createElement("input");
		input.type = inputType;
		input.value = defaultValue;
		input.placeholder = placeholder || "";
		Object.assign(input.style, {
			width: "100%",
			padding: "10px",
			border: "1px solid #e4e9f0",
			borderRadius: "8px",
			fontSize: "14px",
			boxSizing: "border-box",
		});
		group.appendChild(input);

		// ì—ëŸ¬ ë©”ì‹œì§€ div ì¶”ê°€
		const errorDiv = document.createElement("div");
		errorDiv.className = "error-message";
		Object.assign(errorDiv.style, {
			color: "#e74c3c",
			fontSize: "12px",
			height: "16px",
			marginTop: "4px",
			display: "block",
		});
		group.appendChild(errorDiv);

		// ì…ë ¥ ì´ë²¤íŠ¸ë¡œ ì‹¤ì‹œê°„ ê²€ì¦
		if (validator) {
			input.addEventListener("input", () => {
				const msg = validator(input.value);
				errorDiv.textContent = msg || "";
				if (msg) {
					input.style.borderColor = "#e74c3c";
				} else {
					input.style.borderColor = "#e4e9f0";
				}
			});
		}

		return { group, input, errorDiv };
	}

	// í˜ì´ì§€ ì…ë ¥
	const pagesInput = createInputGroup(
		"ì†Œì„¤ ëª©ë¡ì˜ í˜ì´ì§€ ìˆ˜",
		"number",
		"1",
		"í˜ì´ì§€ ìˆ˜ ì…ë ¥",
		"1000í™”ê°€ ë„˜ì§€ ì•ŠëŠ” ê²½ìš° 1, 1000í™” ì´ìƒë¶€í„° 2~ ì…ë ¥",
		(value) => {
			if (Number.isNaN(Number(value)) || Number(value) < 1) {
				return "ìœ íš¨í•œ í˜ì´ì§€ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
			}
			return null;
		},
	);
	dialogContent.appendChild(pagesInput.group);
	pagesInput.input.min = 1;

	// ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
	const buttonsContainer = document.createElement("div");
	Object.assign(buttonsContainer.style, {
		display: "flex",
		justifyContent: "space-between",
		marginTop: "16px",
		gap: "12px",
	});

	// ì·¨ì†Œ ë²„íŠ¼
	const cancelButton = document.createElement("button");
	cancelButton.textContent = "ì·¨ì†Œ";
	Object.assign(cancelButton.style, {
		flex: "1",
		padding: "10px",
		border: "1px solid #e4e9f0",
		borderRadius: "8px",
		backgroundColor: "#f9f9fb",
		cursor: "pointer",
		fontSize: "14px",
		fontWeight: "500",
		transition: "all 0.2s ease",
	});

	cancelButton.onmouseover = () => {
		cancelButton.style.backgroundColor = "#f0f2f8";
	};

	cancelButton.onmouseout = () => {
		cancelButton.style.backgroundColor = "#f9f9fb";
	};

	cancelButton.onclick = () => document.body.removeChild(dialog);
	buttonsContainer.appendChild(cancelButton);

	// ê³„ì† ë²„íŠ¼
	const continueButton = document.createElement("button");
	continueButton.textContent = "ê³„ì†";
	Object.assign(continueButton.style, {
		flex: "1",
		padding: "10px",
		border: "none",
		borderRadius: "8px",
		backgroundColor: "#3a7bd5",
		color: "white",
		cursor: "pointer",
		fontSize: "14px",
		fontWeight: "500",
		transition: "all 0.2s ease",
	});

	continueButton.onmouseover = () => {
		continueButton.style.backgroundColor = "#2d62aa";
	};

	continueButton.onmouseout = () => {
		continueButton.style.backgroundColor = "#3a7bd5";
	};

	buttonsContainer.appendChild(continueButton);

	dialogContent.appendChild(buttonsContainer);
	dialog.appendChild(dialogContent);
	document.body.appendChild(dialog);

	// ê³„ì† ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
	continueButton.onclick = async () => {
		const totalPages = Number.parseInt(pagesInput.input.value, 10);
		console.log("[runCrawler] ì‚¬ìš©ì ì…ë ¥ í˜ì´ì§€ ìˆ˜:", totalPages);

		if (Number.isNaN(totalPages) || totalPages < 1) {
			alert("ìœ íš¨í•œ í˜ì´ì§€ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
			console.log("[runCrawler] ì˜ëª»ëœ í˜ì´ì§€ ìˆ˜ ì…ë ¥, ì¢…ë£Œ");
			return;
		}

		document.body.removeChild(dialog);

		// ë¡œë”© ëŒ€í™” ìƒì í‘œì‹œ
		const loadingDialog = document.createElement("div");
		Object.assign(loadingDialog.style, {
			position: "fixed",
			zIndex: "9999",
			left: "0",
			top: "0",
			width: "100%",
			height: "100%",
			backgroundColor: "rgba(0,0,0,0.5)",
			display: "flex",
			alignItems: "center",
			justifyContent: "center",
			fontFamily:
				'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
		});

		const loadingContent = document.createElement("div");
		Object.assign(loadingContent.style, {
			backgroundColor: "#fff",
			borderRadius: "12px",
			boxShadow: "0 4px 24px rgba(0,0,0,0.15)",
			width: "300px",
			maxWidth: "90%",
			padding: "24px",
			textAlign: "center",
		});

		const loadingTitle = document.createElement("h3");
		loadingTitle.textContent = "ì—í”¼ì†Œë“œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘";
		Object.assign(loadingTitle.style, {
			margin: "0 0 16px 0",
			color: "#172238",
			fontSize: "16px",
			fontWeight: "600",
		});
		loadingContent.appendChild(loadingTitle);

		const loadingText = document.createElement("p");
		loadingText.textContent = "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...";
		Object.assign(loadingText.style, {
			margin: "0 0 20px 0",
			fontSize: "14px",
			color: "#555",
		});
		loadingContent.appendChild(loadingText);

		// ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ìš© CSSë¥¼ ë™ì ìœ¼ë¡œ ì¶”ê°€
		if (!document.getElementById("custom-spinner-style")) {
			const style = document.createElement("style");
			style.id = "custom-spinner-style";
			style.textContent = `
				@keyframes custom-spin {
					0% { transform: rotate(0deg); }
					100% { transform: rotate(360deg); }
				}
				.custom-spinner {
					width: 32px;
					height: 32px;
					border: 3px solid #f3f3f3;
					border-top: 3px solid #3a7bd5;
					border-radius: 50%;
					animation: custom-spin 1s linear infinite;
				}
			`;
			document.head.appendChild(style);
		}

		// ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìƒì„±
		const spinnerContainer = document.createElement("div");
		Object.assign(spinnerContainer.style, {
			display: "flex",
			justifyContent: "center",
			alignItems: "center",
			marginBottom: "16px",
		});

		const spinner = document.createElement("div");
		spinner.className = "custom-spinner";

		spinnerContainer.appendChild(spinner);
		loadingContent.appendChild(spinnerContainer);

		loadingDialog.appendChild(loadingContent);
		document.body.appendChild(loadingDialog);

		// ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ì™€ í•¨ê»˜ ëª¨ë“  ì—í”¼ì†Œë“œ ë§í¬ ê°€ì ¸ì˜¤ê¸°
		const allEpisodeLinks = [];
		for (let page = 1; page <= totalPages; page++) {
			loadingText.textContent = `í˜ì´ì§€ ${page}/${totalPages} ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`;
			const nextPageUrl = `${currentUrl}?spage=${page}`;
			console.log(`[runCrawler] í˜ì´ì§€ ${page} URL:`, nextPageUrl);
			const nextPageDoc = await fetchPage(nextPageUrl);
			if (nextPageDoc) {
				const nextPageLinks = Array.from(
					nextPageDoc.querySelectorAll(".item-subject"),
				).map((link) => link.getAttribute("href"));
				console.log(
					`[runCrawler] í˜ì´ì§€ ${page} ì—í”¼ì†Œë“œ ë§í¬ ìˆ˜:`,
					nextPageLinks.length,
				);
				allEpisodeLinks.push(...nextPageLinks);
				loadingText.textContent = `${allEpisodeLinks.length}ê°œ ì—í”¼ì†Œë“œ ë°œê²¬ë¨`;
			} else {
				console.log(`[runCrawler] í˜ì´ì§€ ${page} ë¡œë“œ ì‹¤íŒ¨`);
			}
			// ì†ë„ ì œí•œì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ì•½ê°„ì˜ ì§€ì—°
			await new Promise((r) => setTimeout(r, 500));
		}

		console.log("[runCrawler] ì „ì²´ ì—í”¼ì†Œë“œ ë§í¬ ìˆ˜:", allEpisodeLinks.length);

		document.body.removeChild(loadingDialog);

		if (allEpisodeLinks.length === 0) {
			alert("ì—í”¼ì†Œë“œ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
			console.log("[runCrawler] ì—í”¼ì†Œë“œ ë§í¬ ì—†ìŒ, ì¢…ë£Œ");
			return;
		}

		// ì—í”¼ì†Œë“œ ë²”ìœ„ ëŒ€í™” ìƒì ìƒì„±
		const rangeDialog = document.createElement("div");
		Object.assign(rangeDialog.style, {
			position: "fixed",
			zIndex: "9999",
			left: "0",
			top: "0",
			width: "100%",
			height: "100%",
			backgroundColor: "rgba(0,0,0,0.5)",
			display: "flex",
			alignItems: "center",
			justifyContent: "center",
			fontFamily:
				'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
		});

		const rangeContent = document.createElement("div");
		Object.assign(rangeContent.style, {
			backgroundColor: "#fff",
			borderRadius: "12px",
			boxShadow: "0 4px 24px rgba(0,0,0,0.15)",
			width: "400px",
			maxWidth: "90%",
			padding: "24px",
			animation: "fadeIn 0.3s",
		});

		const rangeTitle = document.createElement("h3");
		rangeTitle.textContent = "ë‹¤ìš´ë¡œë“œ ë²”ìœ„ ì„¤ì •";
		Object.assign(rangeTitle.style, {
			margin: "0 0 16px 0",
			color: "#172238",
			fontSize: "18px",
			fontWeight: "600",
		});
		rangeContent.appendChild(rangeTitle);

		const episodeCount = document.createElement("div");
		episodeCount.innerHTML = `<span style="display: inline-block; background-color: #ebf5ff; color: #3a7bd5; padding: 4px 8px; border-radius: 4px; font-weight: 500;">ì „ì²´ ${allEpisodeLinks.length}í™”ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</span>`;
		Object.assign(episodeCount.style, {
			margin: "0 0 20px 0",
			fontSize: "14px",
		});
		rangeContent.appendChild(episodeCount);

		// ì‹œì‘ ì—í”¼ì†Œë“œ ì…ë ¥
		const startInput = createInputGroup(
			"ì‹œì‘ íšŒì°¨",
			"number",
			"1",
			"ì‹œì‘ íšŒì°¨ ë²ˆí˜¸",
			"1ë¶€í„° ì‹œì‘",
			(value) => {
				if (Number.isNaN(Number(value)) || Number(value) < 1) {
					return "ìœ íš¨í•œ íšŒì°¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
				}
				return null;
			},
		);
		rangeContent.appendChild(startInput.group);
		startInput.input.min = 1;
		startInput.input.max = allEpisodeLinks.length;

		// ì¢…ë£Œ ì—í”¼ì†Œë“œ ì…ë ¥
		const endInput = createInputGroup(
			"ì¢…ë£Œ íšŒì°¨",
			"number",
			allEpisodeLinks.length.toString(),
			"ì¢…ë£Œ íšŒì°¨ ë²ˆí˜¸",
			"ë§ˆì§€ë§‰ íšŒì°¨ ì…ë ¥",
			(value) => {
				if (
					Number.isNaN(Number(value)) ||
					Number(value) < 1 ||
					Number(value) > allEpisodeLinks.length
				) {
					return "ìœ íš¨í•œ íšŒì°¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
				}
				return null;
			},
		);
		rangeContent.appendChild(endInput.group);
		endInput.input.min = 1;
		endInput.input.max = allEpisodeLinks.length;

		// ê²½ê³ ì™€ í•¨ê»˜ ì§€ì—° ì…ë ¥
		const delayInput = createInputGroup(
			"ë”œë ˆì´ ì„¤ì • (ë°€ë¦¬ì´ˆ)",
			"number",
			"5000",
			"ë”œë ˆì´ ì…ë ¥",
			"âš ï¸ ê¶Œì¥: ê¸°ë³¸ê°’(5000ms=5ì´ˆ)ì„ ìœ ì§€í•˜ì„¸ìš”. ë³€ê²½ ì‹œ ì°¨ë‹¨ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.",
			(value) => {
				if (Number.isNaN(Number(value)) || Number(value) < 1000) {
					return "ìœ íš¨í•œ ë”œë ˆì´ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 1000ms)";
				}
				return null;
			},
		);
		rangeContent.appendChild(delayInput.group);
		delayInput.input.min = 1000;
		delayInput.input.style.border = "1px solid #ffcc00";
		delayInput.input.style.backgroundColor = "#fffbf0";

		// ì¼ì‹œì •ì§€ ê°„ê²© ì…ë ¥
		const pauseIntervalInput = createInputGroup(
			"ì¼ì‹œì •ì§€ ê°„ê²© (í™”ìˆ˜)",
			"number",
			"53",
			"ì¼ì‹œì •ì§€ ê°„ê²© ì…ë ¥",
			"ğŸ’¡ ì§€ì •í•œ í™”ìˆ˜ë§ˆë‹¤ ìë™ìœ¼ë¡œ ì¼ì‹œì •ì§€ë©ë‹ˆë‹¤. 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ìë™ ì¼ì‹œì •ì§€ê°€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.",
			(value) => {
				if (Number.isNaN(Number(value)) || Number(value) < 0) {
					return "ìœ íš¨í•œ ê°„ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (0 ì´ìƒ)";
				}
				return null;
			},
		);
		rangeContent.appendChild(pauseIntervalInput.group);
		pauseIntervalInput.input.min = 0;

		// ë²”ìœ„ ë²„íŠ¼
		const rangeButtons = document.createElement("div");
		Object.assign(rangeButtons.style, {
			display: "flex",
			justifyContent: "space-between",
			marginTop: "20px",
			gap: "12px",
		});

		// ì·¨ì†Œ ë²„íŠ¼
		const rangeCancelButton = document.createElement("button");
		rangeCancelButton.textContent = "ì·¨ì†Œ";
		Object.assign(rangeCancelButton.style, {
			flex: "1",
			padding: "10px",
			border: "1px solid #e4e9f0",
			borderRadius: "8px",
			backgroundColor: "#f9f9fb",
			cursor: "pointer",
			fontSize: "14px",
			fontWeight: "500",
			transition: "all 0.2s ease",
		});

		rangeCancelButton.onmouseover = () => {
			rangeCancelButton.style.backgroundColor = "#f0f2f8";
		};

		rangeCancelButton.onmouseout = () => {
			rangeCancelButton.style.backgroundColor = "#f9f9fb";
		};

		rangeCancelButton.onclick = () => document.body.removeChild(rangeDialog);
		rangeButtons.appendChild(rangeCancelButton);

		// ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
		const downloadButton = document.createElement("button");
		downloadButton.textContent = "ë‹¤ìš´ë¡œë“œ";
		Object.assign(downloadButton.style, {
			flex: "1",
			padding: "10px",
			border: "none",
			borderRadius: "8px",
			backgroundColor: "#3a7bd5",
			color: "white",
			cursor: "pointer",
			fontSize: "14px",
			fontWeight: "500",
			transition: "all 0.2s ease",
		});

		downloadButton.onmouseover = () => {
			downloadButton.style.backgroundColor = "#2d62aa";
		};

		downloadButton.onmouseout = () => {
			downloadButton.style.backgroundColor = "#3a7bd5";
		};

		rangeButtons.appendChild(downloadButton);

		rangeContent.appendChild(rangeButtons);

		// í•˜ë‹¨ì— ê°œë°œì ì—°ë½ì²˜ ë§í¬ ì¶”ê°€
		const contactContainer = document.createElement("div");
		Object.assign(contactContainer.style, {
			marginTop: "16px",
			textAlign: "center",
			fontSize: "13px",
		});

		const contactLink = document.createElement("a");
		contactLink.href = "mailto:yeorinhieut@gmail.com";
		contactLink.textContent = "ê°œë°œìì—ê²Œ ì—°ë½í•˜ê¸°";
		Object.assign(contactLink.style, {
			color: "#666",
			textDecoration: "none",
			borderBottom: "1px dotted #999",
		});

		contactLink.onmouseover = () => {
			contactLink.style.color = "#3a7bd5";
			contactLink.style.borderBottom = "1px dotted #3a7bd5";
		};

		contactLink.onmouseout = () => {
			contactLink.style.color = "#666";
			contactLink.style.borderBottom = "1px dotted #999";
		};

		contactContainer.appendChild(contactLink);

		// êµ¬ë¶„ ê¸°í˜¸ ì¶”ê°€
		const separator = document.createElement("span");
		separator.textContent = " Â· ";
		separator.style.color = "#999";
		contactContainer.appendChild(separator);

		// ë¬¸ì œ ë³´ê³  ë§í¬ ì¶”ê°€
		const issueLink = document.createElement("a");
		issueLink.href = "https://github.com/yeorinhieut/novel-dl/issues";
		issueLink.textContent = "ì˜¤ë¥˜ ì œë³´í•˜ê¸°";
		issueLink.target = "_blank"; // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
		Object.assign(issueLink.style, {
			color: "#666",
			fontSize: "13px",
			textDecoration: "none",
			borderBottom: "1px dotted #999",
		});

		issueLink.onmouseover = () => {
			issueLink.style.color = "#3a7bd5";
			issueLink.style.borderBottom = "1px dotted #3a7bd5";
		};

		issueLink.onmouseout = () => {
			issueLink.style.color = "#666";
			issueLink.style.borderBottom = "1px dotted #999";
		};

		contactContainer.appendChild(issueLink);
		rangeContent.appendChild(contactContainer);

		rangeDialog.appendChild(rangeContent);
		document.body.appendChild(rangeDialog);

		// ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
		downloadButton.onclick = () => {
			const startEpisode = Number.parseInt(startInput.input.value, 10);
			const endEpisode = Number.parseInt(endInput.input.value, 10);
			console.log("[runCrawler] ë‹¤ìš´ë¡œë“œ ë²”ìœ„ ì…ë ¥:", {
				startEpisode,
				endEpisode,
			});

			if (
				Number.isNaN(startEpisode) ||
				Number.isNaN(endEpisode) ||
				startEpisode < 1 ||
				endEpisode < startEpisode ||
				endEpisode > allEpisodeLinks.length
			) {
				alert("ìœ íš¨í•œ íšŒì°¨ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				console.log("[runCrawler] ì˜ëª»ëœ íšŒì°¨ ë²”ìœ„ ì…ë ¥, ì¢…ë£Œ");
				return;
			}

			const delay = Number.parseInt(delayInput.input.value, 10);
			console.log("[runCrawler] ë”œë ˆì´ ì…ë ¥:", delay);
			if (Number.isNaN(delay) || delay < 1000) {
				alert("ìœ íš¨í•œ ë”œë ˆì´ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 1000ms)");
				console.log("[runCrawler] ì˜ëª»ëœ ë”œë ˆì´ ì…ë ¥, ì¢…ë£Œ");
				return;
			}

			const pauseInterval = Number.parseInt(pauseIntervalInput.input.value, 10);
			console.log("[runCrawler] ì¼ì‹œì •ì§€ ê°„ê²© ì…ë ¥:", pauseInterval);
			if (Number.isNaN(pauseInterval) || pauseInterval < 0) {
				alert("ìœ íš¨í•œ ì¼ì‹œì •ì§€ ê°„ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (0 ì´ìƒ)");
				console.log("[runCrawler] ì˜ëª»ëœ ì¼ì‹œì •ì§€ ê°„ê²© ì…ë ¥, ì¢…ë£Œ");
				return;
			}

			document.body.removeChild(rangeDialog);

			console.log(
				`ì‘ì—… ì¶”ê°€ë¨: ${title} ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘ (${startEpisode}í™”ë¶€í„° ${endEpisode}í™”ê¹Œì§€, ì¼ì‹œì •ì§€ ê°„ê²©: ${pauseInterval}í™”)`,
			);

			downloadNovel(title, allEpisodeLinks, startEpisode, endEpisode, delay, pauseInterval);
		};

		// ëª¨ë‹¬ append í›„ ì²« inputì— focus, keydownìœ¼ë¡œ Tab/Shift+Tab, ESC ë‹«ê¸° ì§€ì›
		setModalAccessibility(
			rangeDialog,
			startInput.input,
			() => document.body.removeChild(rangeDialog),
			downloadButton,
		);
	};

	// ì…ë ¥ ëª¨ë‹¬ ìƒì„± í›„ setModalAccessibility(dialog, pagesInput.input, () => document.body.removeChild(dialog), continueButton);
	// ë²”ìœ„ ëª¨ë‹¬ ìƒì„± í›„ setModalAccessibility(rangeDialog, startInput.input, () => document.body.removeChild(rangeDialog), downloadButton);
}

function setModalAccessibility(
	modal,
	firstInput,
	closeCallback,
	defaultButton,
) {
	if (firstInput) firstInput.focus();
	modal.tabIndex = -1;
	modal.focus();
	modal.addEventListener("keydown", (e) => {
		const focusable = modal.querySelectorAll(
			'input, button, [tabindex]:not([tabindex="-1"])',
		);
		const focusArr = Array.from(focusable);
		const idx = focusArr.indexOf(document.activeElement);
		if (e.key === "Tab") {
			if (e.shiftKey) {
				if (idx === 0) {
					focusArr[focusArr.length - 1].focus();
					e.preventDefault();
				}
			} else {
				if (idx === focusArr.length - 1) {
					focusArr[0].focus();
					e.preventDefault();
				}
			}
		}
		if (e.key === "Escape") {
			closeCallback();
		}
		if (e.key === "Enter" && defaultButton) {
			// inputì— í¬ì»¤ìŠ¤ê°€ ìˆê±°ë‚˜ ë²„íŠ¼ì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•Œë§Œ ë™ì‘
			if (
				document.activeElement.tagName === "INPUT" ||
				document.activeElement === defaultButton
			) {
				defaultButton.click();
			}
		}
	});
}

runCrawler();

// ì „ì—­ ë‹¨ì¶•í‚¤ ì¶”ê°€ (Ctrl+Shift+Dë¡œ runCrawler ì‹¤í–‰)
document.addEventListener("keydown", (e) => {
	if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "d") {
		e.preventDefault();
		console.log("[í•«í‚¤] Ctrl+Shift+D: runCrawler ì‹¤í–‰");
		runCrawler();
	}
});